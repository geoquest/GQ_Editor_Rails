<%= javascript_include_tag "jquery-1.5.2"  %>
<%= javascript_include_tag "commands/command" %>
<%= javascript_include_tag "commands/npctalk" %>

<%= render 'shared/header' %>

<%= render 'shared/mission_navigation' %>
<%= render 'shared/editor_control' %>

<script language="javascript" type="text/javascript">

var mission_id = "<%= @mission.attributes['id'] %>";
var project_id = "<%= @project.id %>";

function addDialogEntry() {
  var cmd = new AddDialogEntryCommand();
  cmd.setParameter("speaker", document.getElementById('speaker').value);
  cmd.setParameter("text", document.getElementById('text').value);
  cmd.setParameter("mission_id", mission_id);
  cmd.setParameter("project_id", project_id);
  cmd.execute();
}

// Parameter button = Button from which the event is sent
function deleteDialogEntry(button) {
  var td = button.parentNode; // Cell to which the button belongs
  var tr = td.parentNode; // Row to which the button belongs
  var index = tr.rowIndex;

  // Note to the index:
  // JavaScript starts at 0, XQuery at 1
  // because we will never need to modify the first row (because it is the header)
  // And the second row equals to the first row in the database, we do not
  // need to modify the index, when we pass it from Javascript to XQuery 

  var cmd = new DeleteDialogEntryCommand();
  cmd.setParameter("index", index);
  cmd.setParameter("mission_id", mission_id);
  cmd.setParameter("project_id", project_id);
  cmd.execute();
}

function moveRowUp(button) {
  var td = button.parentNode; // Cell to which the button belongs
  var tr = td.parentNode; // Row to which the button belongs
  var index = tr.rowIndex;

  if(index == 1)
    return; // Row is at the top

  var cmd = new MoveDialogEntryUpCommand();
  cmd.setParameter("index", index);
  cmd.setParameter("mission_id", mission_id);
  cmd.setParameter("project_id", project_id);
  cmd.execute();
}

function moveRowDown(button) {
  var td = button.parentNode; // Cell to which the button belongs
  var tr = td.parentNode; // Row to which the button belongs
  var index = tr.rowIndex;
  var table = document.getElementById('npcTalkTable');
  // -1 because javascript starts at 0 with counting
  // -1 because the last row contains the form for adding new entries
  var lastIndex = table.rows.length-2;

  if(index == lastIndex)
    return; // Row is at the bottom

  var cmd = new MoveDialogEntryDownCommand();
  cmd.setParameter("index", index);
  cmd.setParameter("mission_id", mission_id);
  cmd.setParameter("project_id", project_id);
  cmd.execute();
}

</script>

<div class="content">
   NPC Talk Mission :) <br />

   <table id="npcTalkTable" class="npcTalkTable">
     <tr class="npcTalkHeader">
       <td> Sprecher </td>
       <td> Text </td>
       <td> </td>
     </tr>
     <% @dialogitems.each do |dialogitem| %>
     <tr class="npcTalkRow">
       <td class="npcTalkCell npcTalkSpeakerCell"> <%= dialogitem.attributes['speaker'] %> </td>
       <td class="npcTalkCell"> <%= dialogitem.text %> </td>
       <td class="npcTalkCell"> 
         <input type="image" src="/images/delete.png" value="X" onclick="deleteDialogEntry(this)" />
       </td>
       <td class="npcTalkCell">
         <input type="image" src="/images/up.png" value="^" onclick="moveRowUp(this)" />
       </td>
       <td class="npcTalkCell">
         <input type="image" src="/images/down.png" value="v" onclick="moveRowDown(this)" />
       </td>
     </tr>
     <% end %>

     <tr>
       <td class="npcTalkSpeakerCell">
         <input type="text" id="speaker" value="Erzähler" size="10" />
       </td>
       <td>
         <!-- <input type="text" id="text" value="Text" /> -->
         <textarea id="text" cols="80" rows="4"  style="width: 100%"></textarea> <br />
         <input type="button" value="Neuen Dialogeintrag hinzufügen" onclick="addDialogEntry()"/>
       </td>
       <td></td>
     </tr>

   </table>

</div>


